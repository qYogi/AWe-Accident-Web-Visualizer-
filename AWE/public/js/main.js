var v=null,S=[];async function z(){window.L||await new Promise((a,e)=>{let t=document.createElement("script");t.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",t.onload=()=>a(),t.onerror=()=>e(new Error("Failed to load Leaflet.js")),document.head.appendChild(t)})}async function k(a,e){await z(),!v&&(v=window.L.map(a,e),v.setView([39.82,-98.58],5),window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(v))}function L(a){v&&(S.forEach(e=>e.remove()),S=[],a.forEach(e=>{if(e.start_lat&&e.start_lng){let t=window.L.marker([Number(e.start_lat),Number(e.start_lng)]);t.addTo(v),S.push(t)}}))}var x=new Map,$=!1;async function V(){window.Chart||await new Promise((a,e)=>{let t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js",t.onload=()=>a(),t.onerror=()=>e(new Error("Failed to load Chart.js")),document.head.appendChild(t)})}async function I(a,e,t,s){await V();let r=x.get(a);if(r)r.data=t,r.update();else{let i=document.getElementById(a);i&&(r=new window.Chart(i,{type:e,data:t,options:s}),x.set(a,r))}}function Y(a){return x.get(a)}function Z(a,e){let t=a.data.datasets[0].data,r=a.data.labels.map((d,l)=>({Label:d,Value:t[l]})),i=window.Papa.unparse(r),o=new Blob([i],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a"),c=URL.createObjectURL(o);n.setAttribute("href",c),n.setAttribute("download",`${e}.csv`),document.body.appendChild(n),n.click(),document.body.removeChild(n)}async function J(a,e,t){let s={type:a.config.type,data:a.data,options:a.options},o=`https://quickchart.io/chart?c=${encodeURIComponent(JSON.stringify(s))}&width=500&height=300&format=${t}`;try{let n=await fetch(o);if(!n.ok)throw new Error(`QuickChart.io request failed: ${n.statusText}`);let c=await n.blob(),d=document.createElement("a"),l=URL.createObjectURL(c);d.href=l,d.download=`${e}.${t}`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(l)}catch(n){console.error("Failed to download chart image.",n)}}function G(){document.querySelectorAll(".chart-export-btn").forEach(a=>{a.addEventListener("click",async e=>{let t=e.currentTarget,s=t.dataset.chart,r=t.dataset.format;if(!s||!r){console.error("Error on chartId or format.");return}let i=Y(s);if(!i){console.error(`Chart instance with id ${s} not found.`);return}r==="csv"?Z(i,s):(r==="webp"||r==="svg")&&await J(i,s,r)})}),$=!0}function Q(a){let e=[0,0,0,0];a.forEach(o=>{let n=parseInt(o.severity);n>=1&&n<=4&&e[n-1]++}),I("severityChart","bar",{labels:["1","2","3","4"],datasets:[{label:"Number of Accidents",data:e,backgroundColor:["#4e79a7","#f28e2b","#e15759","#76b7b2"]}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accident Severity Distribution"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Severity Level"}}}});let t={};a.forEach(o=>{let n=new Date(o.start_time).toLocaleDateString();t[n]=(t[n]||0)+1});let s=Object.keys(t).sort(),r=s.map(o=>t[o]);I("trendChart","line",{labels:s,datasets:[{label:"Accidents",data:r,borderColor:"#4e79a7",backgroundColor:"rgba(78,121,167,0.1)",tension:.2}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accident Trends Over Time"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Date"}}}});let i=Array(24).fill(0);a.forEach(o=>{let n=new Date(o.start_time).getHours();i[n]++}),I("hourChart","bar",{labels:Array.from({length:24},(o,n)=>n+":00"),datasets:[{label:"Accidents",data:i,backgroundColor:"#4e79a7"}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accidents by Hour of Day"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Hour of Day"}}}}),$||G()}var f=Q;var B=class{constructor(){this.currentSort=null,this.originalData=[],this.setupSorting()}setData(e){this.originalData=[...e]}setupSorting(){let e=document.querySelector("#accidents-table-head");e&&e.addEventListener("click",t=>{let s=t.target;if(s.tagName==="TH"&&s.classList.contains("sortable-header")){let r=s.getAttribute("data-column");r&&this.handleSort(r)}})}handleSort(e){if(!this.originalData.length)return;let t;if(!this.currentSort||this.currentSort.column!==e)t="asc";else switch(this.currentSort.state){case"asc":t="desc";break;case"desc":t="neutral";break;default:t="asc"}this.currentSort=t==="neutral"?null:{column:e,state:t},this.updateSortIndicators(e,t);let s=this.sortData(this.originalData,e,t);this.displaySortedData(s)}sortData(e,t,s){return s==="neutral"?[...this.originalData]:[...e].sort((i,o)=>{let n=i[t],c=o[t];return t==="severity"?(n=parseFloat(n)||0,c=parseFloat(c)||0):t==="start_time"||t==="end_time"?(n=new Date(n).getTime(),c=new Date(c).getTime()):(n=(n||"").toString().toLowerCase(),c=(c||"").toString().toLowerCase()),n<c?s==="asc"?-1:1:n>c?s==="asc"?1:-1:0})}updateSortIndicators(e,t){document.querySelectorAll("#accidents-table-head th.sortable-header").forEach(r=>{let i=r,o=i.getAttribute("data-column");i.classList.remove("sort-asc","sort-desc","sort-neutral"),o===e?i.classList.add(`sort-${t}`):i.classList.add("sort-neutral")})}displaySortedData(e){let t=document.querySelector("#accidents-table tbody");t&&(t.innerHTML="",e.forEach(s=>{let r=document.createElement("tr");["id","severity","start_time","end_time","description","street","city","county","state","country"].forEach(o=>{let n=document.createElement("td"),c=s[o]||"";o.includes("time")&&c&&(c=new Date(c).toLocaleString()),n.textContent=c,n.setAttribute("title",c),r.appendChild(n)}),t.appendChild(r)}))}createSortableHeaders(){let e=document.querySelector("#accidents-table-head");if(!e)return;let t=["severity","start_time","end_time","street","city","state"];e.querySelectorAll("th").forEach((r,i)=>{let o=r.textContent?.toLowerCase().replace(/\s+/g,"_")||"";t.includes(o)&&(r.classList.add("sortable-header"),r.setAttribute("data-column",o),r.classList.add("sort-neutral"))})}resetSorting(){this.currentSort=null,this.updateSortIndicators("","neutral"),this.displaySortedData(this.originalData)}},_=new B;function C(a){if("error"in a){let o=document.querySelector("#accidents-table-head"),n=document.querySelector("#accidents-table tbody");if(!o||!n)return;o.innerHTML="",n.innerHTML="";let c=document.createElement("tr"),d=document.createElement("td");d.colSpan=10,d.style.cssText="text-align: center; color: #e15759; font-weight: bold; padding: 2rem;",d.textContent=a.error,c.appendChild(d),n.appendChild(c);let l=document.getElementById("pagination-controls");l&&(l.innerHTML=""),L([]),f([]);return}let{accidents:e}=a,t=document.querySelector("#accidents-table-head"),s=document.querySelector("#accidents-table tbody");if(!t||!s)return;t.innerHTML="",s.innerHTML="";let r=["id","severity","start_time","end_time","description","street","city","county","state","country"],i=document.createElement("tr");r.forEach(o=>{let n=document.createElement("th");n.textContent=o.split("_").map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join(" "),n.setAttribute("title",n.textContent),i.appendChild(n)}),t.appendChild(i),_.setData(e),_.createSortableHeaders(),e.forEach(o=>{let n=document.createElement("tr");r.forEach(c=>{let d=document.createElement("td"),l=o[c]||"";c.includes("time")&&l&&(l=new Date(l).toLocaleString()),d.textContent=l,d.setAttribute("title",l),n.appendChild(d)}),s.appendChild(n)}),L(e),f(e)}function T(a,e,t,s){if(a.innerHTML="",t<=1)return;let r=document.createElement("select");r.className="pagination-select";for(let o=1;o<=t;o++){let n=document.createElement("option");n.value=o.toString(),n.textContent=`Page ${o} of ${t}`,o===e&&(n.selected=!0),r.appendChild(n)}r.addEventListener("change",o=>{let n=parseInt(o.target.value,10);s(n)});let i=document.createElement("label");i.textContent="Go to page: ",i.appendChild(r),a.appendChild(i)}var p=new Set,h=new Set;function H(a,e){a.trim()&&!h.has(a.trim())&&(h.add(a.trim()),e())}function M(a,e){h.delete(a),e()}function j(a,e){let t=document.getElementById("state"),s=document.getElementById("city-input-section");t.value&&!p.has(t.value)&&(p.add(t.value),a(),s.style.display="block"),t.value=""}function P(a,e,t){if(p.delete(a),e(),p.size===0){let s=document.getElementById("city-input-section");s.style.display="none",h.clear(),t()}}function A(){let a=document.getElementById("states-list"),e=document.getElementById("selected-states");p.size>0?(a.innerHTML="",p.forEach(t=>{let s=document.querySelector(`#state option[value="${t}"]`),r=s?s.textContent:t,i=document.createElement("div");i.style.cssText="background: #4e79a7; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; display: flex; align-items: center; gap: 0.5rem;",i.innerHTML=`
        <span>\u2713 ${r}</span>
        <button type="button" onclick="removeState('${t}')" style="background: none; border: none; color: white; cursor: pointer; font-weight: bold;">\xD7</button>
      `,a.appendChild(i)}),e.style.display="block"):e.style.display="none"}function w(){let a=document.getElementById("cities-list");a.innerHTML="",h.forEach(e=>{let t=document.createElement("div");t.style.cssText="background: #f28e2b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; display: flex; align-items: center; gap: 0.5rem;",t.innerHTML=`
      <span>${e}</span>
      <button type="button" onclick="removeCity('${e}')" style="background: none; border: none; color: white; cursor: pointer; font-weight: bold;">\xD7</button>
    `,a.appendChild(t)})}function q(a,e="accidents.csv"){if(!a.length){alert("No data to export. Please run a search first.");return}let t=Papa.unparse(a),s=new Blob([t],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a");r.href=URL.createObjectURL(s),r.setAttribute("download",e),document.body.appendChild(r),r.click(),document.body.removeChild(r)}var N=[],D=1;function m(a){return a<10?"0"+a:a.toString()}function K(){let a=new Date,e=a.getFullYear(),t=[];for(let c=2e3;c<=e;c++)t.push(c);let s=Array.from({length:12},(c,d)=>d+1),r=Array.from({length:31},(c,d)=>d+1),i=Array.from({length:24},(c,d)=>m(d)),o=Array.from({length:60},(c,d)=>m(d));function n(c,d){c.innerHTML=d.map(l=>`<option value="${m(Number(l))}">${m(Number(l))}</option>`).join("")}n(document.getElementById("start_day"),r),n(document.getElementById("end_day"),r),n(document.getElementById("start_month"),s),n(document.getElementById("end_month"),s),n(document.getElementById("start_year"),t),n(document.getElementById("end_year"),t),n(document.getElementById("start_hour"),i),n(document.getElementById("end_hour"),i),n(document.getElementById("start_minute"),o),n(document.getElementById("end_minute"),o),document.getElementById("start_day").value=m(a.getDate()),document.getElementById("start_month").value=m(a.getMonth()+1),document.getElementById("start_year").value=a.getFullYear().toString(),document.getElementById("end_day").value=m(a.getDate()),document.getElementById("end_month").value=m(a.getMonth()+1),document.getElementById("end_year").value=a.getFullYear().toString(),document.getElementById("start_hour").value=m(0),document.getElementById("start_minute").value=m(0),document.getElementById("end_hour").value=m(23),document.getElementById("end_minute").value=m(59)}async function R(a){D=a;let e=`${document.getElementById("start_year").value}-${document.getElementById("start_month").value}-${document.getElementById("start_day").value} ${document.getElementById("start_hour").value}:${document.getElementById("start_minute").value}:00`,t=`${document.getElementById("end_year").value}-${document.getElementById("end_month").value}-${document.getElementById("end_day").value} ${document.getElementById("end_hour").value}:${document.getElementById("end_minute").value}:59`;document.getElementById("start_date").value=e,document.getElementById("end_date").value=t;let s=e,r=t,i=document.getElementById("severity")?.value;try{let o=new URLSearchParams({start_date:s,end_date:r,page:D.toString()});p.size>0&&p.forEach(u=>o.append("state",u)),h.size>0&&h.forEach(u=>o.append("city",u)),i!=="0"&&o.append("severity",i);let n=fetch(`/api/accidents?${o.toString()}`).then(u=>{if(!u.ok)throw new Error("Network response was not ok");return u.json()}),c=fetch(`/api/accidents/for-charts?${o.toString()}`).then(u=>{if(!u.ok)throw new Error("Chart data fetch failed");return u.json()}),[d,l]=await Promise.all([n,c]),y=d,U=l,g=document.getElementById("results"),b=document.getElementById("charts"),E=document.getElementById("no-results-message");if("error"in y){C(y),g&&g.classList.remove("hidden"),E&&E.classList.add("hidden"),b&&b.classList.add("hidden"),f([]);return}if(N=y.accidents,y.total===0)g&&g.classList.add("hidden"),E&&E.classList.remove("hidden"),b&&b.classList.add("hidden"),C({accidents:[],total:0,page:1,limit:10}),f([]);else{C(y),f(U),g&&g.classList.remove("hidden"),b&&b.classList.remove("hidden"),E&&E.classList.add("hidden");let u=document.getElementById("pagination-controls");if(u){let F=Math.ceil(y.total/y.limit);T(u,D,F,O=>{R(O)})}}}catch(o){console.error("Error:",o),alert("Error fetching accident data")}}document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{k("map")},50),K(),document.getElementById("state").addEventListener("change",()=>j(A,w));let e=document.getElementById("city-input");e.addEventListener("keypress",i=>{if(i.key==="Enter"){i.preventDefault();let o=e.value.trim();o&&(H(o,w),e.value="")}});let t=document.getElementById("severity"),s=document.getElementById("severity-value");t&&s&&(s.textContent=t.value==="0"?"All":t.value,t.addEventListener("input",()=>{s.textContent=t.value==="0"?"All":t.value})),document.getElementById("date-form")?.addEventListener("submit",async i=>{i.preventDefault();let o=document.getElementById("search-button"),n=document.getElementById("header-content"),c=document.getElementById("loading-animation");if(!o.disabled){o.disabled=!0,n?.classList.add("hidden"),c?.classList.remove("hidden");try{await R(1)}catch(d){console.error("Failed to fetch or display accidents",d),alert("An error occurred. Please try again.")}finally{o.disabled=!1,n?.classList.remove("hidden"),c?.classList.add("hidden")}}});let r=document.getElementById("export-button");r&&r.addEventListener("click",()=>{q(N)}),window.removeState=i=>P(i,A,w),window.removeCity=i=>M(i,w)});
