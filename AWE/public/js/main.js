import*as L from"https://esm.sh/leaflet@1.9.4";var I=null,_=[];function M(t,a){I||(I=L.map(t,a),I.setView([39.82,-98.58],5),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(I))}function k(t){I&&(_.forEach(a=>a.remove()),_=[],t.forEach(a=>{if(a.start_lat&&a.start_lng){let e=L.marker([Number(a.start_lat),Number(a.start_lng)]);e.addTo(I),_.push(e)}}))}var F=new Map,N=!1;function A(t,a,e,i){let o=F.get(t);if(o)o.data=e,o.update();else{let c=document.getElementById(t);c&&(o=new window.Chart(c,{type:a,data:e,options:i}),F.set(t,o))}}function se(t){return F.get(t)}function ce(t,a){let e=t.data.datasets[0].data,o=t.data.labels.map((l,d)=>({Label:l,Value:e[d]})),c=window.Papa.unparse(o),r=new Blob([c],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a"),s=URL.createObjectURL(r);n.setAttribute("href",s),n.setAttribute("download",`${a}.csv`),document.body.appendChild(n),n.click(),document.body.removeChild(n)}async function de(t,a,e){let i={type:t.config.type,data:t.data,options:t.options},r=`https://quickchart.io/chart?c=${encodeURIComponent(JSON.stringify(i))}&width=500&height=300&format=${e}`;try{let n=await fetch(r);if(!n.ok)throw new Error(`QuickChart.io request failed: ${n.statusText}`);let s=await n.blob(),l=document.createElement("a"),d=URL.createObjectURL(s);l.href=d,l.download=`${a}.${e}`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(d)}catch(n){console.error("Failed to download chart image.",n)}}function le(){document.querySelectorAll(".chart-export-btn").forEach(t=>{t.addEventListener("click",async a=>{let e=a.currentTarget,i=e.dataset.chart,o=e.dataset.format;if(!i||!o){console.error("Error on chartId or format.");return}let c=se(i);if(!c){console.error(`Chart instance with id ${i} not found.`);return}o==="csv"?ce(c,i):(o==="webp"||o==="svg")&&await de(c,i,o)})}),N=!0}function ue(t){let a=[0,0,0,0];t.forEach(r=>{let n=parseInt(r.severity);n>=1&&n<=4&&a[n-1]++}),A("severityChart","bar",{labels:["1","2","3","4"],datasets:[{label:"Number of Accidents",data:a,backgroundColor:["#4e79a7","#f28e2b","#e15759","#76b7b2"]}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accident Severity Distribution"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Severity Level"}}}});let e={};t.forEach(r=>{let n=new Date(r.start_time).toLocaleDateString();e[n]=(e[n]||0)+1});let i=Object.keys(e).sort(),o=i.map(r=>e[r]);A("trendChart","line",{labels:i,datasets:[{label:"Accidents",data:o,borderColor:"#4e79a7",backgroundColor:"rgba(78,121,167,0.1)",tension:.2}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accident Trends Over Time"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Date"}}}});let c=Array(24).fill(0);t.forEach(r=>{let n=new Date(r.start_time).getHours();c[n]++}),A("hourChart","bar",{labels:Array.from({length:24},(r,n)=>n+":00"),datasets:[{label:"Accidents",data:c,backgroundColor:"#4e79a7"}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accidents by Hour of Day"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Hour of Day"}}}}),N||le()}var v=ue;var O=class{constructor(){this.currentSort=null,this.originalData=[],this.setupSorting()}setData(a){this.originalData=[...a]}setupSorting(){let a=document.querySelector("#accidents-table-head");a&&a.addEventListener("click",e=>{let i=e.target;if(i.tagName==="TH"&&i.classList.contains("sortable-header")){let o=i.getAttribute("data-column");o&&this.handleSort(o)}})}handleSort(a){if(!this.originalData.length)return;let e;if(!this.currentSort||this.currentSort.column!==a)e="asc";else switch(this.currentSort.state){case"asc":e="desc";break;case"desc":e="neutral";break;default:e="asc"}this.currentSort=e==="neutral"?null:{column:a,state:e},this.updateSortIndicators(a,e);let i=this.sortData(this.originalData,a,e);this.displaySortedData(i)}sortData(a,e,i){return i==="neutral"?[...this.originalData]:[...a].sort((c,r)=>{let n=c[e],s=r[e];return e==="severity"?(n=parseFloat(n)||0,s=parseFloat(s)||0):e==="start_time"||e==="end_time"?(n=new Date(n).getTime(),s=new Date(s).getTime()):(n=(n||"").toString().toLowerCase(),s=(s||"").toString().toLowerCase()),n<s?i==="asc"?-1:1:n>s?i==="asc"?1:-1:0})}updateSortIndicators(a,e){document.querySelectorAll("#accidents-table-head th.sortable-header").forEach(o=>{let c=o,r=c.getAttribute("data-column");c.classList.remove("sort-asc","sort-desc","sort-neutral"),r===a?c.classList.add(`sort-${e}`):c.classList.add("sort-neutral")})}displaySortedData(a){let e=document.querySelector("#accidents-table tbody");e&&(e.innerHTML="",a.forEach(i=>{let o=document.createElement("tr");["id","severity","start_time","end_time","description","street","city","county","state","country"].forEach(r=>{let n=document.createElement("td"),s=i[r]||"";r.includes("time")&&s&&(s=new Date(s).toLocaleString()),n.textContent=s,n.setAttribute("title",s),o.appendChild(n)}),e.appendChild(o)}))}createSortableHeaders(){let a=document.querySelector("#accidents-table-head");if(!a)return;let e=["severity","start_time","end_time","street","city","state"];a.querySelectorAll("th").forEach((o,c)=>{let r=o.textContent?.toLowerCase().replace(/\s+/g,"_")||"";e.includes(r)&&(o.classList.add("sortable-header"),o.setAttribute("data-column",r),o.classList.add("sort-neutral"))})}resetSorting(){this.currentSort=null,this.updateSortIndicators("","neutral"),this.displaySortedData(this.originalData)}},$=new O;function B(t){if("error"in t){let r=document.querySelector("#accidents-table-head"),n=document.querySelector("#accidents-table tbody");if(!r||!n)return;r.innerHTML="",n.innerHTML="";let s=document.createElement("tr"),l=document.createElement("td");l.colSpan=10,l.style.cssText="text-align: center; color: #e15759; font-weight: bold; padding: 2rem;",l.textContent=t.error,s.appendChild(l),n.appendChild(s);let d=document.getElementById("pagination-controls");d&&(d.innerHTML=""),k([]),v([]);return}let{accidents:a}=t,e=document.querySelector("#accidents-table-head"),i=document.querySelector("#accidents-table tbody");if(!e||!i)return;e.innerHTML="",i.innerHTML="";let o=["id","severity","start_time","end_time","duration","distance_mi","description","street","city","county","state","country"],c=document.createElement("tr");o.forEach(r=>{let n=document.createElement("th");n.textContent=r.split("_").map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "),n.setAttribute("title",n.textContent),c.appendChild(n)}),e.appendChild(c),$.setData(a),$.createSortableHeaders(),a.forEach(r=>{let n=document.createElement("tr");o.forEach(s=>{let l=document.createElement("td"),d=r[s]||"";if(s.includes("time")&&d&&(d=new Date(d).toLocaleString()),s==="duration"&&d){let u=d;if(u.includes(":")){let g=u.split(":");if(g.length>=2){let b=parseInt(g[0]),S=parseInt(g[1]);b>0?d=`${b}h ${S}m`:d=`${S}m`}}}if(s==="distance_mi"&&d){let u=parseFloat(d);isNaN(u)||(d=`${u.toFixed(2)} mi`)}l.textContent=d,l.setAttribute("title",d),n.appendChild(l)}),i.appendChild(n)}),k(a),v(a)}function W(t,a,e,i){if(t.innerHTML="",e<=1)return;let o=document.createElement("select");o.className="pagination-select";for(let r=1;r<=e;r++){let n=document.createElement("option");n.value=r.toString(),n.textContent=`Page ${r} of ${e}`,r===a&&(n.selected=!0),o.appendChild(n)}o.addEventListener("change",r=>{let n=parseInt(r.target.value,10);i(n)});let c=document.createElement("label");c.textContent="Go to page: ",c.appendChild(o),t.appendChild(c)}var y=new Set,h=new Set,f={duration:"all",distance:"all",weather:"all",timeOfDay:"all",dayOfWeek:"all"};function q(t){f.duration=t}function P(){return f.duration}function R(t){f.distance=t}function U(){return f.distance}function j(t){f.weather=t}function z(){return f.weather}function V(t){f.timeOfDay=t}function Y(){return f.timeOfDay}function Z(t){f.dayOfWeek=t}function G(){return f.dayOfWeek}function J(t,a){t.trim()&&!h.has(t.trim())&&(h.add(t.trim()),a())}function Q(t,a){h.delete(t),a()}function K(t,a){let e=document.getElementById("state"),i=document.getElementById("city-input-section");e.value&&!y.has(e.value)&&(y.add(e.value),t(),i.style.display="block"),e.value=""}function X(t,a,e){if(y.delete(t),a(),y.size===0){let i=document.getElementById("city-input-section");i.style.display="none",h.clear(),e()}}function T(){let t=document.getElementById("states-list"),a=document.getElementById("selected-states");y.size>0?(t.innerHTML="",y.forEach(e=>{let i=document.querySelector(`#state option[value="${e}"]`),o=i?i.textContent:e,c=document.createElement("div");c.style.cssText="background: #4e79a7; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; display: flex; align-items: center; gap: 0.5rem;",c.innerHTML=`
        <span>\u2713 ${o}</span>
        <button type="button" onclick="removeState('${e}')" style="background: none; border: none; color: white; cursor: pointer; font-weight: bold;">\xD7</button>
      `,t.appendChild(c)}),a.style.display="block"):a.style.display="none"}function D(){let t=document.getElementById("cities-list");t.innerHTML="",h.forEach(a=>{let e=document.createElement("div");e.style.cssText="background: #f28e2b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; display: flex; align-items: center; gap: 0.5rem;",e.innerHTML=`
      <span>${a}</span>
      <button type="button" onclick="removeCity('${a}')" style="background: none; border: none; color: white; cursor: pointer; font-weight: bold;">\xD7</button>
    `,t.appendChild(e)})}function ee(t,a="accidents.csv"){if(!t.length){alert("No data to export. Please run a search first.");return}let e=Papa.unparse(t),i=new Blob([e],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a");o.href=URL.createObjectURL(i),o.setAttribute("download",a),document.body.appendChild(o),o.click(),document.body.removeChild(o)}var te=[],H=1;function p(t){return t<10?"0"+t:t.toString()}function me(){let t=new Date,a=t.getFullYear(),e=[];for(let s=2e3;s<=a;s++)e.push(s);let i=Array.from({length:12},(s,l)=>l+1),o=Array.from({length:31},(s,l)=>l+1),c=Array.from({length:24},(s,l)=>p(l)),r=Array.from({length:60},(s,l)=>p(l));function n(s,l){s.innerHTML=l.map(d=>`<option value="${p(Number(d))}">${p(Number(d))}</option>`).join("")}n(document.getElementById("start_day"),o),n(document.getElementById("end_day"),o),n(document.getElementById("start_month"),i),n(document.getElementById("end_month"),i),n(document.getElementById("start_year"),e),n(document.getElementById("end_year"),e),n(document.getElementById("start_hour"),c),n(document.getElementById("end_hour"),c),n(document.getElementById("start_minute"),r),n(document.getElementById("end_minute"),r),document.getElementById("start_day").value=p(t.getDate()),document.getElementById("start_month").value=p(t.getMonth()+1),document.getElementById("start_year").value=t.getFullYear().toString(),document.getElementById("end_day").value=p(t.getDate()),document.getElementById("end_month").value=p(t.getMonth()+1),document.getElementById("end_year").value=t.getFullYear().toString(),document.getElementById("start_hour").value=p(0),document.getElementById("start_minute").value=p(0),document.getElementById("end_hour").value=p(23),document.getElementById("end_minute").value=p(59)}async function ne(t){H=t;let a=`${document.getElementById("start_year").value}-${document.getElementById("start_month").value}-${document.getElementById("start_day").value} ${document.getElementById("start_hour").value}:${document.getElementById("start_minute").value}:00`,e=`${document.getElementById("end_year").value}-${document.getElementById("end_month").value}-${document.getElementById("end_day").value} ${document.getElementById("end_hour").value}:${document.getElementById("end_minute").value}:59`;document.getElementById("start_date").value=a,document.getElementById("end_date").value=e;let i=a,o=e,c=document.getElementById("severity")?.value;try{let r=new URLSearchParams({start_date:i,end_date:o,page:H.toString()});y.size>0&&y.forEach(m=>r.append("state",m)),h.size>0&&h.forEach(m=>r.append("city",m)),c!=="0"&&r.append("severity",c);let n=P(),s=U(),l=z(),d=Y(),u=G();n!=="all"&&r.append("duration",n),s!=="all"&&r.append("distance",s),l!=="all"&&r.append("weather",l),d!=="all"&&r.append("timeOfDay",d),u!=="all"&&r.append("dayOfWeek",u);let g=fetch(`/api/accidents?${r.toString()}`).then(m=>{if(!m.ok)throw new Error("Network response was not ok");return m.json()}),b=fetch(`/api/accidents/for-charts?${r.toString()}`).then(m=>{if(!m.ok)throw new Error("Chart data fetch failed");return m.json()}),[S,ae]=await Promise.all([g,b]),E=S,re=ae,C=document.getElementById("results"),w=document.getElementById("charts"),x=document.getElementById("no-results-message");if("error"in E){B(E),C&&C.classList.remove("hidden"),x&&x.classList.add("hidden"),w&&w.classList.add("hidden"),v([]);return}if(te=E.accidents,E.total===0)C&&C.classList.add("hidden"),x&&x.classList.remove("hidden"),w&&w.classList.add("hidden"),B({accidents:[],total:0,page:1,limit:10}),v([]);else{B(E),v(re),C&&C.classList.remove("hidden"),w&&w.classList.remove("hidden"),x&&x.classList.add("hidden");let m=document.getElementById("pagination-controls");if(m){let oe=Math.ceil(E.total/E.limit);W(m,H,oe,ie=>{ne(ie)})}}}catch(r){console.error("Error:",r),alert("Error fetching accident data")}}document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{M("map")},50),me(),document.getElementById("state").addEventListener("change",()=>K(T,D));let a=document.getElementById("city-input");a.addEventListener("keypress",d=>{if(d.key==="Enter"){d.preventDefault();let u=a.value.trim();u&&(J(u,D),a.value="")}});let e=document.getElementById("severity"),i=document.getElementById("severity-value");e&&i&&(i.textContent=e.value==="0"?"All":e.value,e.addEventListener("input",()=>{i.textContent=e.value==="0"?"All":e.value}));let o=document.getElementById("duration-filter"),c=document.getElementById("distance-filter"),r=document.getElementById("weather-filter"),n=document.getElementById("time-of-day-filter"),s=document.getElementById("day-of-week-filter");o&&o.addEventListener("change",()=>{q(o.value)}),c&&c.addEventListener("change",()=>{R(c.value)}),r&&r.addEventListener("change",()=>{j(r.value)}),n&&n.addEventListener("change",()=>{V(n.value)}),s&&s.addEventListener("change",()=>{Z(s.value)}),document.getElementById("date-form")?.addEventListener("submit",async d=>{d.preventDefault();let u=document.getElementById("search-button"),g=document.getElementById("header-content"),b=document.getElementById("loading-animation");if(!u.disabled){u.disabled=!0,g?.classList.add("hidden"),b?.classList.remove("hidden");try{await ne(1)}catch(S){console.error("Failed to fetch or display accidents",S),alert("An error occurred. Please try again.")}finally{u.disabled=!1,g?.classList.remove("hidden"),b?.classList.add("hidden")}}});let l=document.getElementById("export-button");l&&l.addEventListener("click",()=>{ee(te)}),window.removeState=d=>X(d,T,D),window.removeCity=d=>Q(d,D)});
