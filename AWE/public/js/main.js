import*as S from"https://esm.sh/leaflet@1.9.4";var v=null,I=[];function $(a,n){v||(v=S.map(a,n),v.setView([39.82,-98.58],5),S.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(v))}function L(a){v&&(I.forEach(n=>n.remove()),I=[],a.forEach(n=>{if(n.start_lat&&n.start_lng){let t=S.marker([Number(n.start_lat),Number(n.start_lng)]);t.addTo(v),I.push(t)}}))}var B=new Map,T=!1;function x(a,n,t,s){let r=B.get(a);if(r)r.data=t,r.update();else{let i=document.getElementById(a);i&&(r=new window.Chart(i,{type:n,data:t,options:s}),B.set(a,r))}}function V(a){return B.get(a)}function Y(a,n){let t=a.data.datasets[0].data,r=a.data.labels.map((d,l)=>({Label:d,Value:t[l]})),i=window.Papa.unparse(r),o=new Blob([i],{type:"text/csv;charset=utf-8;"}),e=document.createElement("a"),c=URL.createObjectURL(o);e.setAttribute("href",c),e.setAttribute("download",`${n}.csv`),document.body.appendChild(e),e.click(),document.body.removeChild(e)}async function Z(a,n,t){let s={type:a.config.type,data:a.data,options:a.options},o=`https://quickchart.io/chart?c=${encodeURIComponent(JSON.stringify(s))}&width=500&height=300&format=${t}`;try{let e=await fetch(o);if(!e.ok)throw new Error(`QuickChart.io request failed: ${e.statusText}`);let c=await e.blob(),d=document.createElement("a"),l=URL.createObjectURL(c);d.href=l,d.download=`${n}.${t}`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(l)}catch(e){console.error("Failed to download chart image.",e)}}function G(){document.querySelectorAll(".chart-export-btn").forEach(a=>{a.addEventListener("click",async n=>{let t=n.currentTarget,s=t.dataset.chart,r=t.dataset.format;if(!s||!r){console.error("Error on chartId or format.");return}let i=V(s);if(!i){console.error(`Chart instance with id ${s} not found.`);return}r==="csv"?Y(i,s):(r==="webp"||r==="svg")&&await Z(i,s,r)})}),T=!0}function J(a){let n=[0,0,0,0];a.forEach(o=>{let e=parseInt(o.severity);e>=1&&e<=4&&n[e-1]++}),x("severityChart","bar",{labels:["1","2","3","4"],datasets:[{label:"Number of Accidents",data:n,backgroundColor:["#4e79a7","#f28e2b","#e15759","#76b7b2"]}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accident Severity Distribution"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Severity Level"}}}});let t={};a.forEach(o=>{let e=new Date(o.start_time).toLocaleDateString();t[e]=(t[e]||0)+1});let s=Object.keys(t).sort(),r=s.map(o=>t[o]);x("trendChart","line",{labels:s,datasets:[{label:"Accidents",data:r,borderColor:"#4e79a7",backgroundColor:"rgba(78,121,167,0.1)",tension:.2}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accident Trends Over Time"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Date"}}}});let i=Array(24).fill(0);a.forEach(o=>{let e=new Date(o.start_time).getHours();i[e]++}),x("hourChart","bar",{labels:Array.from({length:24},(o,e)=>e+":00"),datasets:[{label:"Accidents",data:i,backgroundColor:"#4e79a7"}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accidents by Hour of Day"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Hour of Day"}}}}),T||G()}var g=J;var _=class{constructor(){this.currentSort=null,this.originalData=[],this.setupSorting()}setData(n){this.originalData=[...n]}setupSorting(){let n=document.querySelector("#accidents-table-head");n&&n.addEventListener("click",t=>{let s=t.target;if(s.tagName==="TH"&&s.classList.contains("sortable-header")){let r=s.getAttribute("data-column");r&&this.handleSort(r)}})}handleSort(n){if(!this.originalData.length)return;let t;if(!this.currentSort||this.currentSort.column!==n)t="asc";else switch(this.currentSort.state){case"asc":t="desc";break;case"desc":t="neutral";break;default:t="asc"}this.currentSort=t==="neutral"?null:{column:n,state:t},this.updateSortIndicators(n,t);let s=this.sortData(this.originalData,n,t);this.displaySortedData(s)}sortData(n,t,s){return s==="neutral"?[...this.originalData]:[...n].sort((i,o)=>{let e=i[t],c=o[t];return t==="severity"?(e=parseFloat(e)||0,c=parseFloat(c)||0):t==="start_time"||t==="end_time"?(e=new Date(e).getTime(),c=new Date(c).getTime()):(e=(e||"").toString().toLowerCase(),c=(c||"").toString().toLowerCase()),e<c?s==="asc"?-1:1:e>c?s==="asc"?1:-1:0})}updateSortIndicators(n,t){document.querySelectorAll("#accidents-table-head th.sortable-header").forEach(r=>{let i=r,o=i.getAttribute("data-column");i.classList.remove("sort-asc","sort-desc","sort-neutral"),o===n?i.classList.add(`sort-${t}`):i.classList.add("sort-neutral")})}displaySortedData(n){let t=document.querySelector("#accidents-table tbody");t&&(t.innerHTML="",n.forEach(s=>{let r=document.createElement("tr");["id","severity","start_time","end_time","description","street","city","county","state","country"].forEach(o=>{let e=document.createElement("td"),c=s[o]||"";o.includes("time")&&c&&(c=new Date(c).toLocaleString()),e.textContent=c,e.setAttribute("title",c),r.appendChild(e)}),t.appendChild(r)}))}createSortableHeaders(){let n=document.querySelector("#accidents-table-head");if(!n)return;let t=["severity","start_time","end_time","street","city","state"];n.querySelectorAll("th").forEach((r,i)=>{let o=r.textContent?.toLowerCase().replace(/\s+/g,"_")||"";t.includes(o)&&(r.classList.add("sortable-header"),r.setAttribute("data-column",o),r.classList.add("sort-neutral"))})}resetSorting(){this.currentSort=null,this.updateSortIndicators("","neutral"),this.displaySortedData(this.originalData)}},A=new _;function w(a){if("error"in a){let o=document.querySelector("#accidents-table-head"),e=document.querySelector("#accidents-table tbody");if(!o||!e)return;o.innerHTML="",e.innerHTML="";let c=document.createElement("tr"),d=document.createElement("td");d.colSpan=10,d.style.cssText="text-align: center; color: #e15759; font-weight: bold; padding: 2rem;",d.textContent=a.error,c.appendChild(d),e.appendChild(c);let l=document.getElementById("pagination-controls");l&&(l.innerHTML=""),L([]),g([]);return}let{accidents:n}=a,t=document.querySelector("#accidents-table-head"),s=document.querySelector("#accidents-table tbody");if(!t||!s)return;t.innerHTML="",s.innerHTML="";let r=["id","severity","start_time","end_time","description","street","city","county","state","country"],i=document.createElement("tr");r.forEach(o=>{let e=document.createElement("th");e.textContent=o.split("_").map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join(" "),e.setAttribute("title",e.textContent),i.appendChild(e)}),t.appendChild(i),A.setData(n),A.createSortableHeaders(),n.forEach(o=>{let e=document.createElement("tr");r.forEach(c=>{let d=document.createElement("td"),l=o[c]||"";c.includes("time")&&l&&(l=new Date(l).toLocaleString()),d.textContent=l,d.setAttribute("title",l),e.appendChild(d)}),s.appendChild(e)}),L(n),g(n)}function H(a,n,t,s){if(a.innerHTML="",t<=1)return;let r=document.createElement("select");r.className="pagination-select";for(let o=1;o<=t;o++){let e=document.createElement("option");e.value=o.toString(),e.textContent=`Page ${o} of ${t}`,o===n&&(e.selected=!0),r.appendChild(e)}r.addEventListener("change",o=>{let e=parseInt(o.target.value,10);s(e)});let i=document.createElement("label");i.textContent="Go to page: ",i.appendChild(r),a.appendChild(i)}var p=new Set,y=new Set;function M(a,n){a.trim()&&!y.has(a.trim())&&(y.add(a.trim()),n())}function q(a,n){y.delete(a),n()}function N(a,n){let t=document.getElementById("state"),s=document.getElementById("city-input-section");t.value&&!p.has(t.value)&&(p.add(t.value),a(),s.style.display="block"),t.value=""}function P(a,n,t){if(p.delete(a),n(),p.size===0){let s=document.getElementById("city-input-section");s.style.display="none",y.clear(),t()}}function D(){let a=document.getElementById("states-list"),n=document.getElementById("selected-states");p.size>0?(a.innerHTML="",p.forEach(t=>{let s=document.querySelector(`#state option[value="${t}"]`),r=s?s.textContent:t,i=document.createElement("div");i.style.cssText="background: #4e79a7; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; display: flex; align-items: center; gap: 0.5rem;",i.innerHTML=`
        <span>\u2713 ${r}</span>
        <button type="button" onclick="removeState('${t}')" style="background: none; border: none; color: white; cursor: pointer; font-weight: bold;">\xD7</button>
      `,a.appendChild(i)}),n.style.display="block"):n.style.display="none"}function C(){let a=document.getElementById("cities-list");a.innerHTML="",y.forEach(n=>{let t=document.createElement("div");t.style.cssText="background: #f28e2b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; display: flex; align-items: center; gap: 0.5rem;",t.innerHTML=`
      <span>${n}</span>
      <button type="button" onclick="removeCity('${n}')" style="background: none; border: none; color: white; cursor: pointer; font-weight: bold;">\xD7</button>
    `,a.appendChild(t)})}function R(a,n="accidents.csv"){if(!a.length){alert("No data to export. Please run a search first.");return}let t=Papa.unparse(a),s=new Blob([t],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a");r.href=URL.createObjectURL(s),r.setAttribute("download",n),document.body.appendChild(r),r.click(),document.body.removeChild(r)}var U=[],k=1;function m(a){return a<10?"0"+a:a.toString()}function Q(){let a=new Date,n=a.getFullYear(),t=[];for(let c=2e3;c<=n;c++)t.push(c);let s=Array.from({length:12},(c,d)=>d+1),r=Array.from({length:31},(c,d)=>d+1),i=Array.from({length:24},(c,d)=>m(d)),o=Array.from({length:60},(c,d)=>m(d));function e(c,d){c.innerHTML=d.map(l=>`<option value="${m(Number(l))}">${m(Number(l))}</option>`).join("")}e(document.getElementById("start_day"),r),e(document.getElementById("end_day"),r),e(document.getElementById("start_month"),s),e(document.getElementById("end_month"),s),e(document.getElementById("start_year"),t),e(document.getElementById("end_year"),t),e(document.getElementById("start_hour"),i),e(document.getElementById("end_hour"),i),e(document.getElementById("start_minute"),o),e(document.getElementById("end_minute"),o),document.getElementById("start_day").value=m(a.getDate()),document.getElementById("start_month").value=m(a.getMonth()+1),document.getElementById("start_year").value=a.getFullYear().toString(),document.getElementById("end_day").value=m(a.getDate()),document.getElementById("end_month").value=m(a.getMonth()+1),document.getElementById("end_year").value=a.getFullYear().toString(),document.getElementById("start_hour").value=m(0),document.getElementById("start_minute").value=m(0),document.getElementById("end_hour").value=m(23),document.getElementById("end_minute").value=m(59)}async function O(a){k=a;let n=`${document.getElementById("start_year").value}-${document.getElementById("start_month").value}-${document.getElementById("start_day").value} ${document.getElementById("start_hour").value}:${document.getElementById("start_minute").value}:00`,t=`${document.getElementById("end_year").value}-${document.getElementById("end_month").value}-${document.getElementById("end_day").value} ${document.getElementById("end_hour").value}:${document.getElementById("end_minute").value}:59`;document.getElementById("start_date").value=n,document.getElementById("end_date").value=t;let s=n,r=t,i=document.getElementById("severity")?.value;try{let o=new URLSearchParams({start_date:s,end_date:r,page:k.toString()});p.size>0&&p.forEach(u=>o.append("state",u)),y.size>0&&y.forEach(u=>o.append("city",u)),i!=="0"&&o.append("severity",i);let e=fetch(`/api/accidents?${o.toString()}`).then(u=>{if(!u.ok)throw new Error("Network response was not ok");return u.json()}),c=fetch(`/api/accidents/for-charts?${o.toString()}`).then(u=>{if(!u.ok)throw new Error("Chart data fetch failed");return u.json()}),[d,l]=await Promise.all([e,c]),h=d,j=l,f=document.getElementById("results"),b=document.getElementById("charts"),E=document.getElementById("no-results-message");if("error"in h){w(h),f&&f.classList.remove("hidden"),E&&E.classList.add("hidden"),b&&b.classList.add("hidden"),g([]);return}if(U=h.accidents,h.total===0)f&&f.classList.add("hidden"),E&&E.classList.remove("hidden"),b&&b.classList.add("hidden"),w({accidents:[],total:0,page:1,limit:10}),g([]);else{w(h),g(j),f&&f.classList.remove("hidden"),b&&b.classList.remove("hidden"),E&&E.classList.add("hidden");let u=document.getElementById("pagination-controls");if(u){let F=Math.ceil(h.total/h.limit);H(u,k,F,z=>{O(z)})}}}catch(o){console.error("Error:",o),alert("Error fetching accident data")}}document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{$("map")},50),Q(),document.getElementById("state").addEventListener("change",()=>N(D,C));let n=document.getElementById("city-input");n.addEventListener("keypress",i=>{if(i.key==="Enter"){i.preventDefault();let o=n.value.trim();o&&(M(o,C),n.value="")}});let t=document.getElementById("severity"),s=document.getElementById("severity-value");t&&s&&(s.textContent=t.value==="0"?"All":t.value,t.addEventListener("input",()=>{s.textContent=t.value==="0"?"All":t.value})),document.getElementById("date-form")?.addEventListener("submit",async i=>{i.preventDefault();let o=document.getElementById("search-button"),e=document.getElementById("header-content"),c=document.getElementById("loading-animation");if(!o.disabled){o.disabled=!0,e?.classList.add("hidden"),c?.classList.remove("hidden");try{await O(1)}catch(d){console.error("Failed to fetch or display accidents",d),alert("An error occurred. Please try again.")}finally{o.disabled=!1,e?.classList.remove("hidden"),c?.classList.add("hidden")}}});let r=document.getElementById("export-button");r&&r.addEventListener("click",()=>{R(U)}),window.removeState=i=>P(i,D,C),window.removeCity=i=>q(i,C)});
