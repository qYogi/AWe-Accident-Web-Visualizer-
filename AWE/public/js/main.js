import*as v from"https://esm.sh/leaflet@1.9.4";var E=null,w=[];function q(e,t){E||(E=v.map(e,t),E.setView([39.82,-98.58],5),v.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(E))}function x(e){E&&(w.forEach(t=>t.remove()),w=[],e.forEach(t=>{if(t.start_lat&&t.start_lng){let n=v.marker([Number(t.start_lat),Number(t.start_lng)]);n.addTo(E),w.push(n)}}))}var C=new Map,k=!1;function B(e,t,n,l){let r=C.get(e);if(r)r.data=n,r.update();else{let o=document.getElementById(e);o&&(r=new window.Chart(o,{type:t,data:n,options:l}),C.set(e,r))}}function U(e){return C.get(e)}function R(e,t){let n=e.data.datasets[0].data,l=e.data.labels.map((i,s)=>({Label:i,Value:n[s]})),r=window.Papa.unparse(l),o=new Blob([r],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a"),d=URL.createObjectURL(o);a.setAttribute("href",d),a.setAttribute("download",`${t}.csv`),document.body.appendChild(a),a.click(),document.body.removeChild(a)}async function j(e,t,n){let l={type:e.config.type,data:e.data,options:e.options},r=`https://quickchart.io/chart?c=${encodeURIComponent(JSON.stringify(l))}&width=500&height=300&format=${n}`;try{let o=await fetch(r);if(!o.ok)throw new Error(`QuickChart.io request failed: ${o.statusText}`);let a=await o.blob(),d=document.createElement("a"),i=URL.createObjectURL(a);d.href=i,d.download=`${t}.${n}`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(i)}catch(o){console.error("Failed to download chart image.",o)}}function O(){document.querySelectorAll(".chart-export-btn").forEach(e=>{e.addEventListener("click",async t=>{let n=t.currentTarget,l=n.dataset.chart,r=n.dataset.format;if(!l||!r){console.error("Error on chartId or format.");return}let o=U(l);if(!o){console.error(`Chart instance with id ${l} not found.`);return}r==="csv"?R(o,l):(r==="webp"||r==="svg")&&await j(o,l,r)})}),k=!0}function F(e){let t=[0,0,0,0];e.forEach(a=>{let d=parseInt(a.severity);d>=1&&d<=4&&t[d-1]++}),B("severityChart","bar",{labels:["1","2","3","4"],datasets:[{label:"Number of Accidents",data:t,backgroundColor:["#4e79a7","#f28e2b","#e15759","#76b7b2"]}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accident Severity Distribution"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Severity Level"}}}});let n={};e.forEach(a=>{let d=new Date(a.start_time).toLocaleDateString();n[d]=(n[d]||0)+1});let l=Object.keys(n).sort(),r=l.map(a=>n[a]);B("trendChart","line",{labels:l,datasets:[{label:"Accidents",data:r,borderColor:"#4e79a7",backgroundColor:"rgba(78,121,167,0.1)",tension:.2}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accident Trends Over Time"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Date"}}}});let o=Array(24).fill(0);e.forEach(a=>{let d=new Date(a.start_time).getHours();o[d]++}),B("hourChart","bar",{labels:Array.from({length:24},(a,d)=>d+":00"),datasets:[{label:"Accidents",data:o,backgroundColor:"#4e79a7"}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accidents by Hour of Day"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Hour of Day"}}}}),k||O()}var I=F,P=class{constructor(){this.currentSort=null,this.originalData=[],this.setupSorting()}setData(e){this.originalData=[...e]}setupSorting(){let e=document.querySelector("#accidents-table-head");e&&e.addEventListener("click",t=>{let n=t.target;if(n.tagName==="TH"&&n.classList.contains("sortable-header")){let l=n.getAttribute("data-column");l&&this.handleSort(l)}})}handleSort(e){if(!this.originalData.length)return;let t;if(!this.currentSort||this.currentSort.column!==e)t="asc";else switch(this.currentSort.state){case"asc":t="desc";break;case"desc":t="neutral";break;default:t="asc"}this.currentSort=t==="neutral"?null:{column:e,state:t},this.updateSortIndicators(e,t);let n=this.sortData(this.originalData,e,t);this.displaySortedData(n)}sortData(e,t,n){return n==="neutral"?[...this.originalData]:[...e].sort((l,r)=>{let o=l[t],a=r[t];return t==="severity"?(o=parseFloat(o)||0,a=parseFloat(a)||0):t==="start_time"||t==="end_time"?(o=new Date(o).getTime(),a=new Date(a).getTime()):(o=(o||"").toString().toLowerCase(),a=(a||"").toString().toLowerCase()),o<a?n==="asc"?-1:1:o>a?n==="asc"?1:-1:0})}updateSortIndicators(e,t){document.querySelectorAll("#accidents-table-head th.sortable-header").forEach(n=>{let l=n,r=l.getAttribute("data-column");l.classList.remove("sort-asc","sort-desc","sort-neutral"),r===e?l.classList.add(`sort-${t}`):l.classList.add("sort-neutral")})}displaySortedData(e){let t=document.querySelector("#accidents-table tbody");t&&(t.innerHTML="",e.forEach(n=>{let l=document.createElement("tr");["id","severity","start_time","end_time","description","street","city","county","state","country"].forEach(r=>{let o=document.createElement("td"),a=n[r]||"";r.includes("time")&&a&&(a=new Date(a).toLocaleString()),o.textContent=a,o.setAttribute("title",a),l.appendChild(o)}),t.appendChild(l)}))}createSortableHeaders(){let e=document.querySelector("#accidents-table-head");if(!e)return;let t=["severity","start_time","end_time","street","city","state"];e.querySelectorAll("th").forEach((n,l)=>{let r=n.textContent?.toLowerCase().replace(/\s+/g,"_")||"";t.includes(r)&&(n.classList.add("sortable-header"),n.setAttribute("data-column",r),n.classList.add("sort-neutral"))})}resetSorting(){this.currentSort=null,this.updateSortIndicators("","neutral"),this.displaySortedData(this.originalData)}},A=new P;function S(e){if("error"in e){let a=document.querySelector("#accidents-table-head"),d=document.querySelector("#accidents-table tbody");if(!a||!d)return;a.innerHTML="",d.innerHTML="";let i=document.createElement("tr"),s=document.createElement("td");s.colSpan=10,s.style.cssText="text-align: center; color: #e15759; font-weight: bold; padding: 2rem;",s.textContent=e.error,i.appendChild(s),d.appendChild(i);let c=document.getElementById("pagination-controls");c&&(c.innerHTML=""),x([]),I([]);return}let{accidents:t}=e,n=document.querySelector("#accidents-table-head"),l=document.querySelector("#accidents-table tbody");if(!n||!l)return;n.innerHTML="",l.innerHTML="";let r=["id","severity","start_time","end_time","description","street","city","county","state","country"],o=document.createElement("tr");r.forEach(a=>{let d=document.createElement("th");d.textContent=a.split("_").map(i=>i.charAt(0).toUpperCase()+i.slice(1)).join(" "),d.setAttribute("title",d.textContent),o.appendChild(d)}),n.appendChild(o),A.setData(t),A.createSortableHeaders(),t.forEach(a=>{let d=document.createElement("tr");r.forEach(i=>{let s=document.createElement("td"),c=a[i]||"";i.includes("time")&&c&&(c=new Date(c).toLocaleString()),s.textContent=c,s.setAttribute("title",c),d.appendChild(s)}),l.appendChild(d)}),x(t),I(t)}function z(e,t,n,l){if(e.innerHTML="",n<=1)return;let r=document.createElement("select");r.className="pagination-select";for(let a=1;a<=n;a++){let d=document.createElement("option");d.value=a.toString(),d.textContent=`Page ${a} of ${n}`,a===t&&(d.selected=!0),r.appendChild(d)}r.addEventListener("change",a=>{let d=parseInt(a.target.value,10);l(d)});let o=document.createElement("label");o.textContent="Go to page: ",o.appendChild(r),e.appendChild(o)}var y=new Set,p=new Set;function Y(e,t){e.trim()&&!p.has(e.trim())&&(p.add(e.trim()),t())}function Z(e,t){p.delete(e),t()}function V(e,t){let n=document.getElementById("state"),l=document.getElementById("city-input-section");n.value&&!y.has(n.value)&&(y.add(n.value),e(),l.style.display="block"),n.value=""}function G(e,t,n){if(y.delete(e),t(),y.size===0){let l=document.getElementById("city-input-section");l.style.display="none",p.clear(),n()}}function D(){let e=document.getElementById("states-list"),t=document.getElementById("selected-states");y.size>0?(e.innerHTML="",y.forEach(n=>{let l=document.querySelector(`#state option[value="${n}"]`),r=l?l.textContent:n,o=document.createElement("div");o.style.cssText="background: #4e79a7; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; display: flex; align-items: center; gap: 0.5rem;",o.innerHTML=`
        <span>\u2713 ${r}</span>
        <button type="button" onclick="removeState('${n}')" style="background: none; border: none; color: white; cursor: pointer; font-weight: bold;">\xD7</button>
      `,e.appendChild(o)}),t.style.display="block"):t.style.display="none"}function L(){let e=document.getElementById("cities-list");e.innerHTML="",p.forEach(t=>{let n=document.createElement("div");n.style.cssText="background: #f28e2b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; display: flex; align-items: center; gap: 0.5rem;",n.innerHTML=`
      <span>${t}</span>
      <button type="button" onclick="removeCity('${t}')" style="background: none; border: none; color: white; cursor: pointer; font-weight: bold;">\xD7</button>
    `,e.appendChild(n)})}function J(e,t="accidents.csv"){if(!e.length){alert("No data to export. Please run a search first.");return}let n=Papa.unparse(e),l=new Blob([n],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a");r.href=URL.createObjectURL(l),r.setAttribute("download",t),document.body.appendChild(r),r.click(),document.body.removeChild(r)}var $=[],_=1;function m(e){return e<10?"0"+e:e.toString()}function Q(){let e=new Date,t=e.getFullYear(),n=[];for(let i=2e3;i<=t;i++)n.push(i);let l=Array.from({length:12},(i,s)=>s+1),r=Array.from({length:31},(i,s)=>s+1),o=Array.from({length:24},(i,s)=>m(s)),a=Array.from({length:60},(i,s)=>m(s));function d(i,s){i.innerHTML=s.map(c=>`<option value="${m(Number(c))}">${m(Number(c))}</option>`).join("")}d(document.getElementById("start_day"),r),d(document.getElementById("end_day"),r),d(document.getElementById("start_month"),l),d(document.getElementById("end_month"),l),d(document.getElementById("start_year"),n),d(document.getElementById("end_year"),n),d(document.getElementById("start_hour"),o),d(document.getElementById("end_hour"),o),d(document.getElementById("start_minute"),a),d(document.getElementById("end_minute"),a),document.getElementById("start_day").value=m(e.getDate()),document.getElementById("start_month").value=m(e.getMonth()+1),document.getElementById("start_year").value=e.getFullYear().toString(),document.getElementById("end_day").value=m(e.getDate()),document.getElementById("end_month").value=m(e.getMonth()+1),document.getElementById("end_year").value=e.getFullYear().toString(),document.getElementById("start_hour").value=m(0),document.getElementById("start_minute").value=m(0),document.getElementById("end_hour").value=m(23),document.getElementById("end_minute").value=m(59)}async function T(e){_=e;let t=`${document.getElementById("start_year").value}-${document.getElementById("start_month").value}-${document.getElementById("start_day").value} ${document.getElementById("start_hour").value}:${document.getElementById("start_minute").value}:00`,n=`${document.getElementById("end_year").value}-${document.getElementById("end_month").value}-${document.getElementById("end_day").value} ${document.getElementById("end_hour").value}:${document.getElementById("end_minute").value}:59`;document.getElementById("start_date").value=t,document.getElementById("end_date").value=n;let l=t,r=n,o=document.getElementById("severity")?.value;try{let a=new URLSearchParams({start_date:l,end_date:r,page:_.toString()});y.size>0&&y.forEach(u=>a.append("state",u)),p.size>0&&p.forEach(u=>a.append("city",u)),o!=="0"&&a.append("severity",o);let d=fetch(`/api/accidents?${a.toString()}`).then(u=>{if(!u.ok)throw new Error("Network response was not ok");return u.json()}),i=fetch(`/api/accidents/for-charts?${a.toString()}`).then(u=>{if(!u.ok)throw new Error("Chart data fetch failed");return u.json()}),[s,c]=await Promise.all([d,i]),h=s,H=c,g=document.getElementById("results"),f=document.getElementById("charts"),b=document.getElementById("no-results-message");if("error"in h){S(h),g&&g.classList.remove("hidden"),b&&b.classList.add("hidden"),f&&f.classList.add("hidden"),I([]);return}if($=h.accidents,h.total===0)g&&g.classList.add("hidden"),b&&b.classList.remove("hidden"),f&&f.classList.add("hidden"),S({accidents:[],total:0,page:1,limit:10}),I([]);else{S(h),I(H),g&&g.classList.remove("hidden"),f&&f.classList.remove("hidden"),b&&b.classList.add("hidden");let u=document.getElementById("pagination-controls");if(u){let M=Math.ceil(h.total/h.limit);z(u,_,M,N=>{T(N)})}}}catch(a){console.error("Error:",a),alert("Error fetching accident data")}}document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{q("map")},50),Q(),document.getElementById("state").addEventListener("change",()=>V(D,L));let e=document.getElementById("city-input");e.addEventListener("keypress",r=>{if(r.key==="Enter"){r.preventDefault();let o=e.value.trim();o&&(Y(o,L),e.value="")}});let t=document.getElementById("severity"),n=document.getElementById("severity-value");t&&n&&(n.textContent=t.value==="0"?"All":t.value,t.addEventListener("input",()=>{n.textContent=t.value==="0"?"All":t.value})),document.getElementById("date-form")?.addEventListener("submit",async r=>{r.preventDefault();let o=document.getElementById("search-button"),a=document.getElementById("header-content"),d=document.getElementById("loading-animation");if(!o.disabled){o.disabled=!0,a?.classList.add("hidden"),d?.classList.remove("hidden");try{await T(1)}catch(i){console.error("Failed to fetch or display accidents",i),alert("An error occurred. Please try again.")}finally{o.disabled=!1,a?.classList.remove("hidden"),d?.classList.add("hidden")}}});let l=document.getElementById("export-button");l&&l.addEventListener("click",()=>{J($)}),window.removeState=r=>G(r,D,L),window.removeCity=r=>Z(r,L)});
