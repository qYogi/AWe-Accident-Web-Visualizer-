import*as f from"https://esm.sh/leaflet@1.9.4";var m=null,u=[];function b(e){m&&(u.forEach(t=>t.remove()),u=[],e.forEach(t=>{if(t.start_lat&&t.start_lng){let r=f.marker([Number(t.start_lat),Number(t.start_lng)]);r.addTo(m),u.push(r)}}))}var p=new Map,S=!1;function h(e,t,r,i){let l=p.get(e);if(l)l.data=r,l.update();else{let n=document.getElementById(e);n&&(l=new window.Chart(n,{type:t,data:r,options:i}),p.set(e,l))}}function C(e){return p.get(e)}function E(e,t){let r=e.data.datasets[0].data,i=e.data.labels.map((s,c)=>({Label:s,Value:r[c]})),l=window.Papa.unparse(i),n=new Blob([l],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a"),o=URL.createObjectURL(n);a.setAttribute("href",o),a.setAttribute("download",`${t}.csv`),document.body.appendChild(a),a.click(),document.body.removeChild(a)}async function v(e,t,r){let i={type:e.config.type,data:e.data,options:e.options},l=`https://quickchart.io/chart?c=${encodeURIComponent(JSON.stringify(i))}&width=500&height=300&format=${r}`;try{let n=await fetch(l);if(!n.ok)throw new Error(`QuickChart.io request failed: ${n.statusText}`);let a=await n.blob(),o=document.createElement("a"),s=URL.createObjectURL(a);o.href=s,o.download=`${t}.${r}`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)}catch(n){console.error("Failed to download chart image.",n)}}function w(){document.querySelectorAll(".chart-export-btn").forEach(e=>{e.addEventListener("click",async t=>{let r=t.currentTarget,i=r.dataset.chart,l=r.dataset.format;if(!i||!l){console.error("Error on chartId or format.");return}let n=C(i);if(!n){console.error(`Chart instance with id ${i} not found.`);return}l==="csv"?E(n,i):(l==="webp"||l==="svg")&&await v(n,i,l)})}),S=!0}function L(e){let t=[0,0,0,0];e.forEach(a=>{let o=parseInt(a.severity);o>=1&&o<=4&&t[o-1]++}),h("severityChart","bar",{labels:["1","2","3","4"],datasets:[{label:"Number of Accidents",data:t,backgroundColor:["#4e79a7","#f28e2b","#e15759","#76b7b2"]}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accident Severity Distribution"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Severity Level"}}}});let r={};e.forEach(a=>{let o=new Date(a.start_time).toLocaleDateString();r[o]=(r[o]||0)+1});let i=Object.keys(r).sort(),l=i.map(a=>r[a]);h("trendChart","line",{labels:i,datasets:[{label:"Accidents",data:l,borderColor:"#4e79a7",backgroundColor:"rgba(78,121,167,0.1)",tension:.2}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accident Trends Over Time"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Date"}}}});let n=Array(24).fill(0);e.forEach(a=>{let o=new Date(a.start_time).getHours();n[o]++}),h("hourChart","bar",{labels:Array.from({length:24},(a,o)=>o+":00"),datasets:[{label:"Accidents",data:n,backgroundColor:"#4e79a7"}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accidents by Hour of Day"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Hour of Day"}}}}),S||w()}var y=L,A=class{constructor(){this.currentSort=null,this.originalData=[],this.setupSorting()}setData(e){this.originalData=[...e]}setupSorting(){let e=document.querySelector("#accidents-table-head");e&&e.addEventListener("click",t=>{let r=t.target;if(r.tagName==="TH"&&r.classList.contains("sortable-header")){let i=r.getAttribute("data-column");i&&this.handleSort(i)}})}handleSort(e){if(!this.originalData.length)return;let t;if(!this.currentSort||this.currentSort.column!==e)t="asc";else switch(this.currentSort.state){case"asc":t="desc";break;case"desc":t="neutral";break;default:t="asc"}this.currentSort=t==="neutral"?null:{column:e,state:t},this.updateSortIndicators(e,t);let r=this.sortData(this.originalData,e,t);this.displaySortedData(r)}sortData(e,t,r){return r==="neutral"?[...this.originalData]:[...e].sort((i,l)=>{let n=i[t],a=l[t];return t==="severity"?(n=parseFloat(n)||0,a=parseFloat(a)||0):t==="start_time"||t==="end_time"?(n=new Date(n).getTime(),a=new Date(a).getTime()):(n=(n||"").toString().toLowerCase(),a=(a||"").toString().toLowerCase()),n<a?r==="asc"?-1:1:n>a?r==="asc"?1:-1:0})}updateSortIndicators(e,t){document.querySelectorAll("#accidents-table-head th.sortable-header").forEach(r=>{let i=r,l=i.getAttribute("data-column");i.classList.remove("sort-asc","sort-desc","sort-neutral"),l===e?i.classList.add(`sort-${t}`):i.classList.add("sort-neutral")})}displaySortedData(e){let t=document.querySelector("#accidents-table tbody");t&&(t.innerHTML="",e.forEach(r=>{let i=document.createElement("tr");["id","severity","start_time","end_time","description","street","city","county","state","country"].forEach(l=>{let n=document.createElement("td"),a=r[l]||"";l.includes("time")&&a&&(a=new Date(a).toLocaleString()),n.textContent=a,n.setAttribute("title",a),i.appendChild(n)}),t.appendChild(i)}))}createSortableHeaders(){let e=document.querySelector("#accidents-table-head");if(!e)return;let t=["severity","start_time","end_time","street","city","state"];e.querySelectorAll("th").forEach((r,i)=>{let l=r.textContent?.toLowerCase().replace(/\s+/g,"_")||"";t.includes(l)&&(r.classList.add("sortable-header"),r.setAttribute("data-column",l),r.classList.add("sort-neutral"))})}resetSorting(){this.currentSort=null,this.updateSortIndicators("","neutral"),this.displaySortedData(this.originalData)}},g=new A;function x(e){if("error"in e){let a=document.querySelector("#accidents-table-head"),o=document.querySelector("#accidents-table tbody");if(!a||!o)return;a.innerHTML="",o.innerHTML="";let s=document.createElement("tr"),c=document.createElement("td");c.colSpan=10,c.style.cssText="text-align: center; color: #e15759; font-weight: bold; padding: 2rem;",c.textContent=e.error,s.appendChild(c),o.appendChild(s);let d=document.getElementById("pagination-controls");d&&(d.innerHTML=""),b([]),y([]);return}let{accidents:t}=e,r=document.querySelector("#accidents-table-head"),i=document.querySelector("#accidents-table tbody");if(!r||!i)return;r.innerHTML="",i.innerHTML="";let l=["id","severity","start_time","end_time","description","street","city","county","state","country"],n=document.createElement("tr");l.forEach(a=>{let o=document.createElement("th");o.textContent=a.split("_").map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "),o.setAttribute("title",o.textContent),n.appendChild(o)}),r.appendChild(n),g.setData(t),g.createSortableHeaders(),t.forEach(a=>{let o=document.createElement("tr");l.forEach(s=>{let c=document.createElement("td"),d=a[s]||"";s.includes("time")&&d&&(d=new Date(d).toLocaleString()),c.textContent=d,c.setAttribute("title",d),o.appendChild(c)}),i.appendChild(o)}),b(t),y(t)}function D(e,t,r,i){if(e.innerHTML="",r<=1)return;let l=document.createElement("select");l.className="pagination-select";for(let a=1;a<=r;a++){let o=document.createElement("option");o.value=a.toString(),o.textContent=`Page ${a} of ${r}`,a===t&&(o.selected=!0),l.appendChild(o)}l.addEventListener("change",a=>{let o=parseInt(a.target.value,10);i(o)});let n=document.createElement("label");n.textContent="Go to page: ",n.appendChild(l),e.appendChild(n)}export{D as createPagination,x as displayAccidents};
