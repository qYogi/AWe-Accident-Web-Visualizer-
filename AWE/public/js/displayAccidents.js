import*as p from"https://esm.sh/leaflet@1.9.4";var L=null,m=[];function f(i){L&&(m.forEach(r=>r.remove()),m=[],i.forEach(r=>{if(r.start_lat&&r.start_lng){let e=p.marker([Number(r.start_lat),Number(r.start_lng)]);e.addTo(L),m.push(e)}}))}var y=new Map,E=!1;function b(i,r,e,o){let a=y.get(i);if(a)a.data=e,a.update();else{let c=document.getElementById(i);c&&(a=new window.Chart(c,{type:r,data:e,options:o}),y.set(i,a))}}function v(i){return y.get(i)}function A(i,r){let e=i.data.datasets[0].data,a=i.data.labels.map((d,l)=>({Label:d,Value:e[l]})),c=window.Papa.unparse(a),n=new Blob([c],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a"),s=URL.createObjectURL(n);t.setAttribute("href",s),t.setAttribute("download",`${r}.csv`),document.body.appendChild(t),t.click(),document.body.removeChild(t)}async function D(i,r,e){let o={type:i.config.type,data:i.data,options:i.options},n=`https://quickchart.io/chart?c=${encodeURIComponent(JSON.stringify(o))}&width=500&height=300&format=${e}`;try{let t=await fetch(n);if(!t.ok)throw new Error(`QuickChart.io request failed: ${t.statusText}`);let s=await t.blob(),d=document.createElement("a"),l=URL.createObjectURL(s);d.href=l,d.download=`${r}.${e}`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(l)}catch(t){console.error("Failed to download chart image.",t)}}function k(){document.querySelectorAll(".chart-export-btn").forEach(i=>{i.addEventListener("click",async r=>{let e=r.currentTarget,o=e.dataset.chart,a=e.dataset.format;if(!o||!a){console.error("Error on chartId or format.");return}let c=v(o);if(!c){console.error(`Chart instance with id ${o} not found.`);return}a==="csv"?A(c,o):(a==="webp"||a==="svg")&&await D(c,o,a)})}),E=!0}function _(i){let r=[0,0,0,0];i.forEach(n=>{let t=parseInt(n.severity);t>=1&&t<=4&&r[t-1]++}),b("severityChart","bar",{labels:["1","2","3","4"],datasets:[{label:"Number of Accidents",data:r,backgroundColor:["#4e79a7","#f28e2b","#e15759","#76b7b2"]}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accident Severity Distribution"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Severity Level"}}}});let e={};i.forEach(n=>{let t=new Date(n.start_time).toLocaleDateString();e[t]=(e[t]||0)+1});let o=Object.keys(e).sort(),a=o.map(n=>e[n]);b("trendChart","line",{labels:o,datasets:[{label:"Accidents",data:a,borderColor:"#4e79a7",backgroundColor:"rgba(78,121,167,0.1)",tension:.2}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accident Trends Over Time"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Date"}}}});let c=Array(24).fill(0);i.forEach(n=>{let t=new Date(n.start_time).getHours();c[t]++}),b("hourChart","bar",{labels:Array.from({length:24},(n,t)=>t+":00"),datasets:[{label:"Accidents",data:c,backgroundColor:"#4e79a7"}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accidents by Hour of Day"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Hour of Day"}}}}),E||k()}var g=_;var C=class{constructor(){this.currentSort=null,this.originalData=[],this.setupSorting()}setData(r){this.originalData=[...r]}setupSorting(){let r=document.querySelector("#accidents-table-head");r&&r.addEventListener("click",e=>{let o=e.target;if(o.tagName==="TH"&&o.classList.contains("sortable-header")){let a=o.getAttribute("data-column");a&&this.handleSort(a)}})}handleSort(r){if(!this.originalData.length)return;let e;if(!this.currentSort||this.currentSort.column!==r)e="asc";else switch(this.currentSort.state){case"asc":e="desc";break;case"desc":e="neutral";break;default:e="asc"}this.currentSort=e==="neutral"?null:{column:r,state:e},this.updateSortIndicators(r,e);let o=this.sortData(this.originalData,r,e);this.displaySortedData(o)}sortData(r,e,o){return o==="neutral"?[...this.originalData]:[...r].sort((c,n)=>{let t=c[e],s=n[e];return e==="severity"?(t=parseFloat(t)||0,s=parseFloat(s)||0):e==="start_time"||e==="end_time"?(t=new Date(t).getTime(),s=new Date(s).getTime()):(t=(t||"").toString().toLowerCase(),s=(s||"").toString().toLowerCase()),t<s?o==="asc"?-1:1:t>s?o==="asc"?1:-1:0})}updateSortIndicators(r,e){document.querySelectorAll("#accidents-table-head th.sortable-header").forEach(a=>{let c=a,n=c.getAttribute("data-column");c.classList.remove("sort-asc","sort-desc","sort-neutral"),n===r?c.classList.add(`sort-${e}`):c.classList.add("sort-neutral")})}displaySortedData(r){let e=document.querySelector("#accidents-table tbody");e&&(e.innerHTML="",r.forEach(o=>{let a=document.createElement("tr");["id","severity","start_time","end_time","description","street","city","county","state","country"].forEach(n=>{let t=document.createElement("td"),s=o[n]||"";n.includes("time")&&s&&(s=new Date(s).toLocaleString()),t.textContent=s,t.setAttribute("title",s),a.appendChild(t)}),e.appendChild(a)}))}createSortableHeaders(){let r=document.querySelector("#accidents-table-head");if(!r)return;let e=["severity","start_time","end_time","street","city","state"];r.querySelectorAll("th").forEach((a,c)=>{let n=a.textContent?.toLowerCase().replace(/\s+/g,"_")||"";e.includes(n)&&(a.classList.add("sortable-header"),a.setAttribute("data-column",n),a.classList.add("sort-neutral"))})}resetSorting(){this.currentSort=null,this.updateSortIndicators("","neutral"),this.displaySortedData(this.originalData)}},S=new C;function M(i){if("error"in i){let n=document.querySelector("#accidents-table-head"),t=document.querySelector("#accidents-table tbody");if(!n||!t)return;n.innerHTML="",t.innerHTML="";let s=document.createElement("tr"),d=document.createElement("td");d.colSpan=10,d.style.cssText="text-align: center; color: #e15759; font-weight: bold; padding: 2rem;",d.textContent=i.error,s.appendChild(d),t.appendChild(s);let l=document.getElementById("pagination-controls");l&&(l.innerHTML=""),f([]),g([]);return}let{accidents:r}=i,e=document.querySelector("#accidents-table-head"),o=document.querySelector("#accidents-table tbody");if(!e||!o)return;e.innerHTML="",o.innerHTML="";let a=["id","severity","start_time","end_time","duration","distance_mi","description","street","city","county","state","country"],c=document.createElement("tr");a.forEach(n=>{let t=document.createElement("th");t.textContent=n.split("_").map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "),t.setAttribute("title",t.textContent),c.appendChild(t)}),e.appendChild(c),S.setData(r),S.createSortableHeaders(),r.forEach(n=>{let t=document.createElement("tr");a.forEach(s=>{let d=document.createElement("td"),l=n[s]||"";if(s.includes("time")&&l&&(l=new Date(l).toLocaleString()),s==="duration"&&l){let u=l;if(u.includes(":")){let h=u.split(":");if(h.length>=2){let w=parseInt(h[0]),x=parseInt(h[1]);w>0?l=`${w}h ${x}m`:l=`${x}m`}}}if(s==="distance_mi"&&l){let u=parseFloat(l);isNaN(u)||(l=`${u.toFixed(2)} mi`)}d.textContent=l,d.setAttribute("title",l),t.appendChild(d)}),o.appendChild(t)}),f(r),g(r)}function U(i,r,e,o){if(i.innerHTML="",e<=1)return;let a=document.createElement("select");a.className="pagination-select";for(let n=1;n<=e;n++){let t=document.createElement("option");t.value=n.toString(),t.textContent=`Page ${n} of ${e}`,n===r&&(t.selected=!0),a.appendChild(t)}a.addEventListener("change",n=>{let t=parseInt(n.target.value,10);o(t)});let c=document.createElement("label");c.textContent="Go to page: ",c.appendChild(a),i.appendChild(c)}export{U as createPagination,M as displayAccidents};
