import*as u from"https://esm.sh/leaflet@1.9.4";var C=null,p=[];function h(s){C&&(p.forEach(r=>r.remove()),p=[],s.forEach(r=>{if(r.start_lat&&r.start_lng){let e=u.marker([Number(r.start_lat),Number(r.start_lng)]);e.addTo(C),p.push(e)}}))}var f=new Map,S=!1;function m(s,r,e,o){let a=f.get(s);if(a)a.data=e,a.update();else{let i=document.getElementById(s);i&&(a=new window.Chart(i,{type:r,data:e,options:o}),f.set(s,a))}}function w(s){return f.get(s)}function x(s,r){let e=s.data.datasets[0].data,a=s.data.labels.map((l,d)=>({Label:l,Value:e[d]})),i=window.Papa.unparse(a),n=new Blob([i],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a"),c=URL.createObjectURL(n);t.setAttribute("href",c),t.setAttribute("download",`${r}.csv`),document.body.appendChild(t),t.click(),document.body.removeChild(t)}async function L(s,r,e){let o={type:s.config.type,data:s.data,options:s.options},n=`https://quickchart.io/chart?c=${encodeURIComponent(JSON.stringify(o))}&width=500&height=300&format=${e}`;try{let t=await fetch(n);if(!t.ok)throw new Error(`QuickChart.io request failed: ${t.statusText}`);let c=await t.blob(),l=document.createElement("a"),d=URL.createObjectURL(c);l.href=d,l.download=`${r}.${e}`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(d)}catch(t){console.error("Failed to download chart image.",t)}}function E(){document.querySelectorAll(".chart-export-btn").forEach(s=>{s.addEventListener("click",async r=>{let e=r.currentTarget,o=e.dataset.chart,a=e.dataset.format;if(!o||!a){console.error("Error on chartId or format.");return}let i=w(o);if(!i){console.error(`Chart instance with id ${o} not found.`);return}a==="csv"?x(i,o):(a==="webp"||a==="svg")&&await L(i,o,a)})}),S=!0}function v(s){let r=[0,0,0,0];s.forEach(n=>{let t=parseInt(n.severity);t>=1&&t<=4&&r[t-1]++}),m("severityChart","bar",{labels:["1","2","3","4"],datasets:[{label:"Number of Accidents",data:r,backgroundColor:["#4e79a7","#f28e2b","#e15759","#76b7b2"]}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accident Severity Distribution"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Severity Level"}}}});let e={};s.forEach(n=>{let t=new Date(n.start_time).toLocaleDateString();e[t]=(e[t]||0)+1});let o=Object.keys(e).sort(),a=o.map(n=>e[n]);m("trendChart","line",{labels:o,datasets:[{label:"Accidents",data:a,borderColor:"#4e79a7",backgroundColor:"rgba(78,121,167,0.1)",tension:.2}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accident Trends Over Time"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Date"}}}});let i=Array(24).fill(0);s.forEach(n=>{let t=new Date(n.start_time).getHours();i[t]++}),m("hourChart","bar",{labels:Array.from({length:24},(n,t)=>t+":00"),datasets:[{label:"Accidents",data:i,backgroundColor:"#4e79a7"}]},{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Accidents by Hour of Day"}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Number of Accidents"}},x:{title:{display:!0,text:"Hour of Day"}}}}),S||E()}var b=v;var y=class{constructor(){this.currentSort=null,this.originalData=[],this.setupSorting()}setData(r){this.originalData=[...r]}setupSorting(){let r=document.querySelector("#accidents-table-head");r&&r.addEventListener("click",e=>{let o=e.target;if(o.tagName==="TH"&&o.classList.contains("sortable-header")){let a=o.getAttribute("data-column");a&&this.handleSort(a)}})}handleSort(r){if(!this.originalData.length)return;let e;if(!this.currentSort||this.currentSort.column!==r)e="asc";else switch(this.currentSort.state){case"asc":e="desc";break;case"desc":e="neutral";break;default:e="asc"}this.currentSort=e==="neutral"?null:{column:r,state:e},this.updateSortIndicators(r,e);let o=this.sortData(this.originalData,r,e);this.displaySortedData(o)}sortData(r,e,o){return o==="neutral"?[...this.originalData]:[...r].sort((i,n)=>{let t=i[e],c=n[e];return e==="severity"?(t=parseFloat(t)||0,c=parseFloat(c)||0):e==="start_time"||e==="end_time"?(t=new Date(t).getTime(),c=new Date(c).getTime()):(t=(t||"").toString().toLowerCase(),c=(c||"").toString().toLowerCase()),t<c?o==="asc"?-1:1:t>c?o==="asc"?1:-1:0})}updateSortIndicators(r,e){document.querySelectorAll("#accidents-table-head th.sortable-header").forEach(a=>{let i=a,n=i.getAttribute("data-column");i.classList.remove("sort-asc","sort-desc","sort-neutral"),n===r?i.classList.add(`sort-${e}`):i.classList.add("sort-neutral")})}displaySortedData(r){let e=document.querySelector("#accidents-table tbody");e&&(e.innerHTML="",r.forEach(o=>{let a=document.createElement("tr");["id","severity","start_time","end_time","description","street","city","county","state","country"].forEach(n=>{let t=document.createElement("td"),c=o[n]||"";n.includes("time")&&c&&(c=new Date(c).toLocaleString()),t.textContent=c,t.setAttribute("title",c),a.appendChild(t)}),e.appendChild(a)}))}createSortableHeaders(){let r=document.querySelector("#accidents-table-head");if(!r)return;let e=["severity","start_time","end_time","street","city","state"];r.querySelectorAll("th").forEach((a,i)=>{let n=a.textContent?.toLowerCase().replace(/\s+/g,"_")||"";e.includes(n)&&(a.classList.add("sortable-header"),a.setAttribute("data-column",n),a.classList.add("sort-neutral"))})}resetSorting(){this.currentSort=null,this.updateSortIndicators("","neutral"),this.displaySortedData(this.originalData)}},g=new y;function q(s){if("error"in s){let n=document.querySelector("#accidents-table-head"),t=document.querySelector("#accidents-table tbody");if(!n||!t)return;n.innerHTML="",t.innerHTML="";let c=document.createElement("tr"),l=document.createElement("td");l.colSpan=10,l.style.cssText="text-align: center; color: #e15759; font-weight: bold; padding: 2rem;",l.textContent=s.error,c.appendChild(l),t.appendChild(c);let d=document.getElementById("pagination-controls");d&&(d.innerHTML=""),h([]),b([]);return}let{accidents:r}=s,e=document.querySelector("#accidents-table-head"),o=document.querySelector("#accidents-table tbody");if(!e||!o)return;e.innerHTML="",o.innerHTML="";let a=["id","severity","start_time","end_time","description","street","city","county","state","country"],i=document.createElement("tr");a.forEach(n=>{let t=document.createElement("th");t.textContent=n.split("_").map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join(" "),t.setAttribute("title",t.textContent),i.appendChild(t)}),e.appendChild(i),g.setData(r),g.createSortableHeaders(),r.forEach(n=>{let t=document.createElement("tr");a.forEach(c=>{let l=document.createElement("td"),d=n[c]||"";c.includes("time")&&d&&(d=new Date(d).toLocaleString()),l.textContent=d,l.setAttribute("title",d),t.appendChild(l)}),o.appendChild(t)}),h(r),b(r)}function $(s,r,e,o){if(s.innerHTML="",e<=1)return;let a=document.createElement("select");a.className="pagination-select";for(let n=1;n<=e;n++){let t=document.createElement("option");t.value=n.toString(),t.textContent=`Page ${n} of ${e}`,n===r&&(t.selected=!0),a.appendChild(t)}a.addEventListener("change",n=>{let t=parseInt(n.target.value,10);o(t)});let i=document.createElement("label");i.textContent="Go to page: ",i.appendChild(a),s.appendChild(i)}export{$ as createPagination,q as displayAccidents};
